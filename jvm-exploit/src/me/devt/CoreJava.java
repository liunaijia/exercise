package me.devt;

import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.io.OutputStreamWriter;
import java.io.UnsupportedEncodingException;
import java.net.HttpURLConnection;
import java.net.InetAddress;
import java.net.InetSocketAddress;
import java.net.MalformedURLException;
import java.net.ServerSocket;
import java.net.Socket;
import java.net.URL;
import java.net.URLConnection;
import java.net.URLEncoder;
import java.util.List;
import java.util.Map;
import java.util.Scanner;

public class CoreJava {
	private void get() throws IOException {
		// 使用URLEncoder进行url编码
		String spec = "http://solr.che168.com/avss?rows=2&fl=" + URLEncoder.encode("sum(Price, MarketPrice)", "utf-8");
		System.out.println(spec);
		
		URL url = new URL(spec);
		URLConnection connection = url.openConnection();
		connection.connect();

		// 输出http头
		for (Map.Entry<String, List<String>> entry : connection
				.getHeaderFields().entrySet()) {
			System.out.println(entry.getKey() + "="
					+ String.join("", entry.getValue()));
		}
		// 输出
		try(BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream()))) {
			String line;
			while((line = reader.readLine()) != null)
				System.out.println(line);
		}
	}
	
	private void post() throws IOException {
		// 设置代理，以便fiddler监控
		System.setProperty("http.proxyHost", "127.0.0.1");
		System.setProperty("http.proxyPort", "8888");
		URL url = new URL("http://10.168.100.164:8080/master/avss/update?wt=json");
		URLConnection connection = url.openConnection();
		try{
			// 启用输出流
			connection.setDoOutput(true);
			// 设置请求头
			connection.setRequestProperty("Content-Type", "application/json");
			connection.connect();
			// 输出post的数据
			// 根据Content-Type的设置决定是否进行URL encode，Content-Type默认为application/x-www-form-urlencoded，所以默认需要url encode
			// A value of "application/x-www-form-urlencoded" means that your POST body will need to be URL encoded just like a GET parameter string.
			// A value of "multipart/form-data" means that you'll be using content delimiters and NOT url encoding the content.
			try(BufferedWriter writer = new BufferedWriter(new OutputStreamWriter(connection.getOutputStream()))) {
				String data = "{\"add\":{ \"doc\":{\"id\":\"change.me\",\"title\":\"change.me\"}}}";
				writer.write(data);
			}
			// 读取响应
			try(BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream()))) {
				String line;
				while((line = reader.readLine()) != null)
					System.out.println(line);
			}
		}
		catch(IOException e) {
			if (!(connection instanceof HttpURLConnection))
				throw e;
			
			try(BufferedReader reader = new BufferedReader(new InputStreamReader(((HttpURLConnection)connection).getErrorStream()))) {
				// 输出错误响应内容
				String line;
				while((line = reader.readLine()) != null)
					System.err.println(line);
			}
			
		}
	}
	
	public static void main(String[] args) throws IOException {
		CoreJava client = new CoreJava();
		//client.get();
		client.post();
		
		
		// 写响应流
		//connection.setDoOutput(true);
		// 设置响应的http头
		//connection.setRequestProperty("Accept", "text/plain; q=0.5, text/html");
		
	}
}
